import express from "express";
import dotenv from "dotenv";
import fetch from "node-fetch";
import path from "path";
import { fileURLToPath } from "url";
import { saveLead, getAllLeads } from "./db.js";

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 4000;

const FB_VERIFY_TOKEN = process.env.FB_VERIFY_TOKEN;
const FB_PAGE_ACCESS_TOKEN = process.env.FB_PAGE_ACCESS_TOKEN;

// Serve CRM frontend
app.use(express.static(path.join(__dirname, "public")));
app.use(express.json());

/* 1. Facebook Webhook Verification */
app.get("/webhooks/facebook-leads", (req, res) => {
  const mode = req.query["hub.mode"];
  const token = req.query["hub.verify_token"];
  const challenge = req.query["hub.challenge"];

  if (mode === "subscribe" && token === FB_VERIFY_TOKEN) {
    console.log("âœ… FB Webhook Verified");
    return res.status(200).send(challenge);
  }

  res.sendStatus(403);
});

/* 2. Facebook Lead Webhook Receiver */
app.post("/webhooks/facebook-leads", async (req, res) => {
  const body = req.body;

  if (body.object === "page") {
    for (const entry of body.entry) {
      for (const change of entry.changes || []) {
        if (change.field === "leadgen") {
          const leadId = change.value.leadgen_id;
          const formId = change.value.form_id;
          const adId = change.value.ad_id;
          const createdTime = change.value.created_time;

          const details = await fetchLeadDetails(leadId);

          const lead = {
            externalId: leadId,
            name: details.name,
            email: details.email,
            phone: details.phone,
            formId,
            adId,
            createdAt: new Date(createdTime * 1000).toISOString(),
            source: "facebook"
          };

          saveLead(lead);
        }
      }
    }
  }

  res.sendStatus(200);
});

/* Fetch Name/Email/Phone */
async function fetchLeadDetails(leadId) {
  try {
    const url = `https://graph.facebook.com/v19.0/${leadId}?access_token=${FB_PAGE_ACCESS_TOKEN}`;
    const res = await fetch(url);
    const data = await res.json();

    const fields = data.field_data || [];
    const map = {};
    fields.forEach(f => (map[f.name] = f.values[0]));

    return {
      name: map.full_name || "",
      email: map.email || "",
      phone: map.phone_number || ""
    };
  } catch (err) {
    console.error("âŒ Error fetching lead details", err);
    return { name: "", email: "", phone: "" };
  }
}

/* 3. Get All Leads for Frontend */
app.get("/api/leads", (req, res) => {
  res.json(getAllLeads());
});

app.listen(PORT, () =>
  console.log(`ðŸš€ CRM running on http://localhost:${PORT}`)
);